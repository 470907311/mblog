<!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="keywords" content="梁康伦,PHP,MySQL,liangkanglun,技术博客" />
		<meta name="description" content="PHP集成开发工程师" />
		<title>梁康伦的博客</title>
		<link href="./css/bootstrap.min.css" rel="stylesheet">
		<style type="text/css">
			#title{width:100%; height:200px; background:#3DC5F9;}
			#ss{font-size:42px; top:60px; position:absolute; left:80px;}
			.form-group{position:absolute; left:700px; top:80px;}
			.container{width:100%;}
			.navbar-nav{margin-left:80px;}
			.navbar-nav li{margin-left:50px;}
			.column{margin-left:50px; border:1px solid #ddd;}

		</style>
	</head>
	<body>
		<div id="title">
			<span id="ss">梁康伦的博客</span>
			<form class="navbar-form navbar-left" role="search">
				<div class="form-group">
					<input class="form-control" type="text" />
					<button type="submit" class="btn btn-default">搜索</button>
				</div>
			</form>
		</div>
		<div class="container">
			<div class="row clearfix">
					<nav class="navbar navbar-default" role="navigation">
						<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1" >
							<ul class="nav navbar-nav">
								<li class="active">
									 <a href="./index.html">首页</a>
								</li>
								<li>
									 <a href="./phpbase.html">PHP</a>
								</li>
								<li>
									 <a href="./master.html">MySQL</a>
								</li>
								<li>
									 <a href="#">微信开发</a>
								</li>
								<li>
									 <a href="#">git</a>
								</li>
								<li>
									 <a href="#">工具</a>
								</li>
								<li>
									 <a href="./zt.html">杂谈</a>
								</li>
							</ul>
						</div>
					</nav>
			</div>
			<div class="row clearfix">
				<div class="col-md-7 column">
					<h2>
						MySQL主从配置
					</h2>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><font size="4">作者：梁康伦</font></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<span><font size="4">时间：2016年10月28日</font></span>
					<br>
					<br>
						<pre><code>
准备
两台linux ContOS6.3
Lamp环境已装好
Ip地址：
主服务器master 192.168.24.87
从服务器slave 192.168.24.88
本机windows  192.168.24.38
三台电脑互通

主服务器master上的操作
mysql> select user,host,password from user;
+------+-----------------------+-------------------------------------------+
| user | host                  | password                                  |
+------+-----------------------+-------------------------------------------+
| root | localhost             | *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |
| root | localhost.localdomain |                                           |
| root | 127.0.0.1             |                                           |
| root | ::1                   |                                           |
|      | localhost             |                                           |
|      | localhost.localdomain |                                           |
+------+-----------------------+-------------------------------------------+
Root用户，只能在本机master登录，下面试验看能否从其他电脑登录

从服务器slave上操作
mysql -uroot -p123 -h192.168.24.88
ERROR 1130 (HY000):Host’192.168.24.88’ is not allowed to this MySQL server
登录被拒绝，需要授权身份


一、授权
grant all on *.* to lun@192.168.24.88 identified by '123';
帮助信息：？Grant
查看用户信息
mysql> select user,host,password from user;
+------+-----------------------+-------------------------------------------+
| user | host                  | password                                  |
+------+-----------------------+-------------------------------------------+
| root | localhost             | *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |
| root | localhost.localdomain |                                           |
| root | 127.0.0.1             |                                           |
| root | ::1                   |                                           |
|      | localhost             |                                           |
|      | localhost.localdomain |                                           |
| lun  | 192.168.24.88         | *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |
+------+-----------------------+-------------------------------------------+

授权成功后，到从服务器上测试登录
mysql -h192.168.24.87 -ulun -p

详细信息
all			是权限
*.*			是某个数据库的某个表
Lun			是登录用户名
192.168.24.88		是从哪台服务器登录  如果是所有的ip地址的话用’%’表示
‘123’			是密码

二、Bin-log日志
Bin-log:	记录数据库变化操作的二进制日志文件
记录了我们操作数据库的所有写操作，以二进制方式存进去
存放在/usr/local/mysql/data/下
直接使用vim打开会是乱码   vim /usr/local/mysql/data/mysql-bin.000013
Linux下直接命令才能正常打开，
/usr/local/mysql/bin/mysqlbinlog /usr/local/mysql/data/mysql-bin.000013


如何开启bin-log日志?
vi /etc/my.cnf
[mysqld]
log-bin=mysql-bin
       默认开启
ls /usr/local/mysql/data/
 mysql-bin.000001
 mysql-bin.000002
记录了所有的数据库变化操作（数据增删改，创建表等）

查看是否开启？
show variables like "%log%";
log_bin     | ON

Bin-log 日志刷新
mysql> flush logs;
Query OK, 0 rows affected (0.02 sec)
开始一个新的bin-log日志，记录此刻以后的操作

刷新完后再显示下 ls /usr/local/mysql/data，这时会添加一个新的日志文件
这相当于重新拿一个笔记本，从第一页的位置开始记录以后的日志，之前的笔记本，不再使用

查看当前使用的bin-log信息
show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000014 |      107 |              |                  |
+------------------+----------+--------------+------------------+
1 row in set (0.00 sec)

一个新的笔记本，默认从107行的位置开始记录。（mysql5.2从106行开始记录）
Position 记录的是位置信息，如果执行增删改语句，位置将发生变化
做一些操作mysql数据库的记录
再一次执行 show master status

在另一终端再次打开最新的bin-log日志
/usr/local/mysql/bin/mysqlbinlog /usr/local/mysql/data/mysql-bin.000014

清空所有的bin-log日志内容
mysql>reset master;

查看bin-log日志内容
cd /usr/local/mysql/data
/usr/local/mysql/bin/mysqlbinlog mysql-bin.000014

Bin-log日志使用测试
use test
选择数据库
reset master
清空所有的bin-log日志
show master status;
当前file是mysql-bin.000001，positon开始位置是从107行开始
create table users(id int,name varchar(50));
此时show master ststus发现position位置已改变成214
insert into users(id,name) values(1,'admin');
此时show master ststus发现position位置已改变成418
insert into users(id,name) values(2,'guest');
此时show master ststus发现position位置已改变成622
查看bin-log日志内容
cd /usr/local/mysql/data
/usr/local/mysql/bin/mysqlbinlog mysql-bin.000001

Bin-log日志，完整记录着每一个position位置执行了什么sql语句，可以用来恢复数据
里面的语句，可以直接拿到命令行执行
/*!40019 SET @@session.max_insert_delayed_threads=0*/;
/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;
DELIMITER /*!*/;
# at 4
#160507 19:43:34 server id 1  end_log_pos 107 	Start: binlog v 4, server v 5.5.23-log created 160507 19:43:34 at startup
# Warning: this binlog is either in use or was not closed properly.
ROLLBACK/*!*/;
BINLOG '
5tQtVw8BAAAAZwAAAGsAAAABAAQANS41LjIzLWxvZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAADm1C1XEzgNAAgAEgAEBAQEEgAAVAAEGggAAAAICAgCAA==
'/*!*/;
# at 107
#160507 19:49:07 server id 1  end_log_pos 213 	Query	thread_id=13	exec_time=0	error_code=0
use test/*!*/;
SET TIMESTAMP=1462621747/*!*/;
SET @@session.pseudo_thread_id=13/*!*/;
SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;
SET @@session.sql_mode=0/*!*/;
SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;
/*!\C utf8 *//*!*/;
SET @@session.character_set_client=33,@@session.collation_connection=33,@@session.collation_server=33/*!*/;
SET @@session.lc_time_names=0/*!*/;
SET @@session.collation_database=DEFAULT/*!*/;
create table users(id int,name varchar(50))
/*!*/;
# at 213
#160507 19:52:21 server id 1  end_log_pos 281 	Query	thread_id=13	exec_time=0	error_code=0
SET TIMESTAMP=1462621941/*!*/;
BEGIN
/*!*/;
# at 281
#160507 19:52:21 server id 1  end_log_pos 388 	Query	thread_id=13	exec_time=0	error_code=0
SET TIMESTAMP=1462621941/*!*/;
insert into users(id,name) values(1,'admin')
/*!*/;
# at 388
#160507 19:52:21 server id 1  end_log_pos 415 	Xid = 24000136
COMMIT/*!*/;
# at 415
#160507 19:52:38 server id 1  end_log_pos 483 	Query	thread_id=13	exec_time=0	error_code=0
SET TIMESTAMP=1462621958/*!*/;
BEGIN
/*!*/;
# at 483
#160507 19:52:38 server id 1  end_log_pos 590 	Query	thread_id=13	exec_time=0	error_code=0
SET TIMESTAMP=1462621958/*!*/;
insert into users(id,name) values(2,'guest')
/*!*/;
# at 590
#160507 19:52:38 server id 1  end_log_pos 617 	Xid = 24000137
COMMIT/*!*/;
DELIMITER ;
# End of log file
ROLLBACK /* added by mysqlbinlog */;
/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;


将此时的mysql-bin.000001文件保留下来，开启一个新的日志文件
flush logs
show master status;

文件file切换为mysql-bin.000002，在这之后操作数据库，日志将记录到这个新的文件中，那么mysql-bin.000001，记录的是以前的操作
此时，如果误删了数据表users
drop table users

如何通过刚才的mysql-bin.000001恢复数据？

cd /usr/local/mysql/data   先到这个目录下

//进行还原
/usr/local/mysql/bin/mysqlbinlog mysql-bin.000001 | /usr/local/mysql/bin/mysql -uroot -p
 相当于把之前执行过的SQL语句，再执行一次，相当于将之前的操作执行一遍，而mysql-bin.000002中，记录的是那句删除的SQL语句，没有执行
这就是bin-log文件的作用！！！

三、完整的备份及恢复实例
MySQL备份和bin-log日志
完整导出整个库
/usr/local/mysql/bin/mysqldump -uroot -p -l -F test>/tmp/test.sql
备份test数据库到/tmp/test.sql
-l 备份时加锁，在整个备份过程中，只允许读操作，不允许写入数据
-F 即flush logs，可以重新生成新的日志文件，当然包括log-bin日志
查看bin-log日志
mysql> show master status;
产生一个新的bin-log文件mysql-bin.000003
完整备份完成之后，所有对数据库的操作，将会记录到这个新的bin-log文件中

接下来，再进行一些对数据库的操作
 insert into users values(3,'lungege');
 update users set name='jack' where id=2;
然后模拟一次误操作，清空所有数据
delete from users;
准备恢复，开始一个新的bin-log日志（目的是保留mysql-bin.000003的现状）
flush logs;
先恢复之前的完整备份文件
mysql -uroot -p test -f<’/tmp/test.sql’;

接着恢复后面的操作，需要从bin-log日志中恢复

查看mysql-bin.000003日志文件
查找误操作在哪一行
发现误操作之后，要恢复执行的操作将从107行开始，在错误行停止，不能整个有误操作的bin-log日志全部执行

/usr/local/mysql/bin/mysqlbinlog mysql-bin.000003 --start-position=’107’ --stop-position=’565’ | mysql -uroot -p123

如果服务器上有多个库，可以通过-d选项，指定恢复哪一个数据库，而不影响其他数据库

/usr/local/mysql/bin/mysqlbinlog mysql-bin.000003 --start-position=’107’ --stop-position=’565’ -d test | mysql -uroot -p123


四、主从复制
Mysql复制的优点主要包括以下3个方面
1.如果主服务器出现问题，可以快速切换到从服务器提供服务
2.可以在从服务器上执行查询操作，降低主服务器的访问压力
3.可以在从服务器上执行备份，以避免备份期间影响主服务器的服务
注意：一般只有更新不频繁的数据或者对实时性要求不高的数据可以通过从服务器查询，实时性要求高的数据仍然需要从主数据库获得

主服务器配置
1.授权一个用户，在从服务器上可以通过这个用户来连接主服务器
grant all on *.* to jack@192.168.24.88 identified by ‘123’;

Select user,host,password from mysq.user;
Show grants for jack@192.168.24.88;
2.修改主数据库服务器的配置文件，开启bin-log并设置server-id的值（默认不需要改）
vi /etc/my.cnf
[mysqld]
log-bin=mysql-bin
server-id = 1
3.主服务器清空所有的bin-log日志
reset master;
show master status;
4.备份主数据库的数据
/usr/local/mysql/bin/mysqldump -uroot -p -l -F test>/tmp/test.sql


从服务器的配置
1.把主服务器的备份文件，拷贝到从服务器上
scp root@192.168.24.87:/tmp/test.sql /tmp/test.sql

2.从备份文件，恢复数据库
mysl -uroot -p test -f <’/tmp/test.sql’;
3.清空所有的bin-log
reset master;    //主从都清空

4.修改配置文件
vi /etc/my.cnf
[mysqld]
log-bin=mysql-bin
server-id = 2

Binlog-do-db=test  #需要同步的数据库
以下根据需求添加
binlog-ignore-dn = mysql  #不复制同步的数据库
binlog-ignore-dn = paybank  #不复制同步的数据库
binlog-ignore-dn = performance_schema  #不复制同步的数据库

注意：
server-id 要唯一，如果前面已经开启或设置，不需要重复设置

确保可以连上主服务器
mysql -h192.168.24.87 -ujack -p

5.重启mysql
6.从服务器进入mysql命令
mysql>stop slave;

mysql> change master to
    -> master_host='192.168.24.87',
    -> master_user='jack',
    -> master_password='123';

mysql> start slave;

show slave status \G;
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
</code></pre>
					<br>
					<br>
				</div>

				<div class="col-md-4 column">
					<h3>博文链接</h3>
					<ul>
						<li>
							<a href="./gd.html">GD库函数使用</a>
						</li>
						<li>
							<a href="./git.html">如何在github上搭建自己的博客</a>
						</li>
						<li>
							<a href="./master.html">MySQL主从配置</a>
						</li>
						<li>
							<a href="./phpbase.html">echo print print_r var_dump的区别</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
    <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
	</body>
</html>
